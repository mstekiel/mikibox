
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mikibox.crysfipy.reion &#8212; mikibox 0.1.0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">mikibox</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../source/mikibox.html">
  Mikibox package
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../source/crysfipy.html">
  CrysFiPy under mikibox package
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for mikibox.crysfipy.reion</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2014-2018 Petr Čermák, Jan Zubáč and Karel Pajskr</span>
<span class="c1"># This file is part of CrysFiPy.</span>
<span class="c1"># CrysFiPy is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>

<span class="c1"># CrysFiPy is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1"># &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">ms</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">const</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span> <span class="nn">.cfmatrix</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">conj</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">dot</span>
<span class="kn">import</span> <span class="nn">numbers</span>

<div class="viewcode-block" id="cfpars"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.cfpars">[docs]</a><span class="k">class</span> <span class="nc">cfpars</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class representing set of crystal field parameters.</span>

<span class="sd">    It simplifies the creation of the CF parameter sets considering symmetry</span>
<span class="sd">    of the environment.</span>
<span class="sd">    Other modules expect that CF parameters are in *meV* (SI units). </span>
<span class="sd">    But if you just want to diagonalize Hamiltonian, it is possible to use *K* (and results will be in *K*).</span>

<span class="sd">    Initialization can be done with named arguments or without. </span>
<span class="sd">    If arguments are not named, symmetry is considered from the first string argument.</span>
<span class="sd">    Stevens parameters are considered differently for different symmetries in following order:</span>

<span class="sd">    | cubic: B40, B60</span>
<span class="sd">    | hexagonal: B20, B40, B44, B66</span>
<span class="sd">    | tetragonal: B20, B40, B44, B60, B64</span>
<span class="sd">    | orthorombic: B20, B22, B40, B42, B44, B60, B62, B64, B66</span>
<span class="sd">    </span>

<span class="sd">    Attributes:</span>
<span class="sd">        BXY (float, optional): Attribute corresponding to :math:`B_X^Y` Stevens Parameters.</span>
<span class="sd">            See Hutchings.  If at least one CF parameter is specified as a named argument, </span>
<span class="sd">            non-named numerical parameters are ignored.</span>
<span class="sd">        sym (str, optional): Symmetry of the crystal field</span>
<span class="sd">            | c - cubic</span>
<span class="sd">            | h - hexagonal</span>
<span class="sd">            | t - tetragonal</span>
<span class="sd">            | o - orthorombic (default)</span>
<span class="sd">           </span>
<span class="sd">    Examples:</span>
<span class="sd">        Create set of CF parameters by named parameters:</span>

<span class="sd">        &gt;&gt;&gt; print(cfpars(sym = &quot;c&quot;, B40 = 10))</span>
<span class="sd">        Set of CF parameters for cubic symmetry:</span>
<span class="sd">        B40 = 10.0000</span>
<span class="sd">        B60 = 0.0000</span>
<span class="sd">        B44 = 50.0000</span>
<span class="sd">        B64 = 0.0000</span>

<span class="sd">        Use of non-named parameters:</span>

<span class="sd">        &gt;&gt;&gt; print(cfpars(&quot;c&quot;, 10, 1))</span>
<span class="sd">        Set of CF parameters for cubic symmetry:</span>
<span class="sd">        B40 = 10.0000</span>
<span class="sd">        B60 = 1.0000</span>
<span class="sd">        B44 = 50.0000</span>
<span class="sd">        B64 = -21.0000</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cubic&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B40&quot;</span><span class="p">,</span> <span class="s2">&quot;B60&quot;</span><span class="p">,</span> <span class="s2">&quot;B44&quot;</span><span class="p">,</span> <span class="s2">&quot;B64&quot;</span><span class="p">]],</span>            
    <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hexagonal&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B20&quot;</span><span class="p">,</span> <span class="s2">&quot;B40&quot;</span><span class="p">,</span> <span class="s2">&quot;B44&quot;</span><span class="p">,</span> <span class="s2">&quot;B66&quot;</span><span class="p">]],</span>              
    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tetragonal&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B20&quot;</span><span class="p">,</span> <span class="s2">&quot;B40&quot;</span><span class="p">,</span> <span class="s2">&quot;B44&quot;</span><span class="p">,</span> <span class="s2">&quot;B60&quot;</span><span class="p">,</span> <span class="s2">&quot;B64&quot;</span><span class="p">]],</span>            
    <span class="s2">&quot;o&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;orthorombic&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B20&quot;</span><span class="p">,</span> <span class="s2">&quot;B22&quot;</span><span class="p">,</span> <span class="s2">&quot;B40&quot;</span><span class="p">,</span> <span class="s2">&quot;B42&quot;</span><span class="p">,</span> <span class="s2">&quot;B44&quot;</span><span class="p">,</span> <span class="s2">&quot;B60&quot;</span><span class="p">,</span> <span class="s2">&quot;B62&quot;</span><span class="p">,</span> <span class="s2">&quot;B64&quot;</span><span class="p">,</span> <span class="s2">&quot;B66&quot;</span><span class="p">]],</span>  
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">skipNonnamed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1">#orthorombic symetry (=no constrains)</span>
        <span class="c1">#clear all params</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asignParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">#check named args</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#check symetry constrain</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;sym&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asignSymmetry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>    
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span>  <span class="c1">#it is a crystal field</span>
                <span class="n">skipNonnamed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_asignParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1">#check non named args</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asignSymmetry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">break</span>  <span class="c1">#just consider first string in list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span> <span class="c1">#default</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skipNonnamed</span><span class="p">:</span>
            <span class="c1">#read</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span> <span class="c1"># this is the only place where `numbers` library is used. TODO to remove it</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span> <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_asignParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1">#do symmetry magic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B44</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B40</span><span class="p">;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B64</span> <span class="o">=</span> <span class="o">-</span><span class="mi">21</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B60</span><span class="p">;</span>
            
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Set of CF parameters for </span><span class="si">%s</span><span class="s2"> symmetry:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span> <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_printParameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>
    
            
    <span class="k">def</span> <span class="nf">_asignSymmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span> <span class="ow">or</span>  <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span> <span class="ow">or</span>  <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                  
    <span class="k">def</span> <span class="nf">_asignParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B20&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B20</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B22&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B22</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B40&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B40</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B42&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B42</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B44&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B44</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B60&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B60</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B62&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B62</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B64&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B64</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B66&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">B66</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">_printParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B20&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B20</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B22&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B22</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B40&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B40</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B42&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B42</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B44&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B44</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B60&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B60</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B62&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B62</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B64&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;B66&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B66</span><span class="p">)</span></div>




<div class="viewcode-block" id="CEFion"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.CEFion">[docs]</a><span class="k">class</span> <span class="nc">CEFion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object representing a rare-earth ion in CF potential</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        ion : ``crysfipy.const.ion`` </span>
<span class="sd">            Name of the ion. They are tabulated in :obj:`const` with their parameters.</span>
<span class="sd">        Hfield : 1D array of floats</span>
<span class="sd">            External magnetic field in *T* units.</span>
<span class="sd">        cfp : ``crysfipy.reion.cfpars``</span>
<span class="sd">            Crystal field parameters</span>
<span class="sd">        diagonalize : bool, optional</span>
<span class="sd">            If true (default) then it automatically diagonalizes Hamiltonian, calculates energy levels and sorts all matrices so that the first eigenvector corresponds to the lowest energy level and the last one to the highest.</span>

<span class="sd">    Examples:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; ce = re(&quot;Ce&quot;, [0,0,0], [&quot;c&quot;, 10])</span>
<span class="sd">        &gt;&gt;&gt; print(ce)</span>
<span class="sd">        Energy levels:</span>
<span class="sd">        E(0) =	0.0000	 2fold-degenerated</span>
<span class="sd">        E(1) =	3600.0000	 4fold-degenerated</span>
<span class="sd">        </span>
<span class="sd">    Attributes:</span>
<span class="sd">        ion : ``crysfipy:ion``</span>
<span class="sd">            The ``ion`` object that represents an isolated rare-earth ion.</span>
<span class="sd">        Jval : int/2</span>
<span class="sd">            The J value corresponding to the L+S quantum numbers. Not to be confused with the ``J`` operator.</span>
<span class="sd">        Hfield : array_like</span>
<span class="sd">            Vector in real space corresponding to the external magnetic field.</span>
<span class="sd">        cfp : ``crysfipy.reion.cfp``</span>
<span class="sd">            Crystal field parameters</span>
<span class="sd">        hamiltonian : ndarray</span>
<span class="sd">            Hamiltonian operator. :math:`\hat{\mathcal{H}} = \sum_{ij} B_i^j \hat{O}_i^j + g_J (H_x \hat{J}_x + H_y \hat{J}_y + H_z \hat{J}_z)`</span>
<span class="sd">        Jx, Jy, Jz : ndarray</span>
<span class="sd">            Matrices representing the prinicpal quantum operators :math:`\hat{J}_\\alpha`` with :math:`\\alpha=[x,y,z]`.</span>
<span class="sd">        J : ndarray</span>
<span class="sd">            Total angular momentum vector operator :math:`\hat{J}=[\hat{J}_x, \hat{J}_y, \hat{J}_z]`. It&#39;s multidimensionality takes some time to get used to.</span>
<span class="sd">        energies : ndarray</span>
<span class="sd">            Eigenenergies of the Hamiltonian.</span>
<span class="sd">        eigenvectors : ndarray</span>
<span class="sd">            Eigenvectors of the Hamiltonian.</span>
<span class="sd">        degeneracies : list</span>
<span class="sd">            List containing entries like [energy, degeneracy], which describes how degenerated is the given energy level.</span>
<span class="sd">        freeionkets : list</span>
<span class="sd">            List of kets corresponding to the J basis of the free ion problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ion</span><span class="p">,</span> <span class="n">Hfield</span><span class="p">,</span> <span class="n">cfp</span><span class="p">,</span> <span class="n">diagonalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ion</span> <span class="o">=</span> <span class="n">ion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Jval</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">J</span>
        <span class="n">Jval</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">J</span>
        
        <span class="c1"># TODO check if the Hfield parameter is appropriate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Hfield</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cfp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">cfp</span> <span class="o">=</span> <span class="n">cfpars</span><span class="p">(</span><span class="o">*</span><span class="n">cfp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfp</span> <span class="o">=</span> <span class="n">cfp</span>
        

        <span class="c1"># Prepare the rest of the fields based on the main input parameters</span>

        <span class="c1"># Main Ji matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Jx</span> <span class="o">=</span> <span class="n">J_x</span><span class="p">(</span><span class="n">Jval</span><span class="p">);</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">Jy</span> <span class="o">=</span> <span class="n">J_y</span><span class="p">(</span><span class="n">Jval</span><span class="p">);</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Jz</span> <span class="o">=</span> <span class="n">J_z</span><span class="p">(</span><span class="n">Jval</span><span class="p">);</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Jx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jz</span><span class="p">]</span>
        
        <span class="c1"># matrix with projection of moments to x, y, z directions for all J2p1 levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Jval</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>  
        
        <span class="c1"># Prepare a list os kets that form the basis</span>
        <span class="k">if</span> <span class="n">Jval</span><span class="o">%</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freeionkets</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;|</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&gt;&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linspace</span><span class="p">(</span><span class="n">Jval</span><span class="p">,</span><span class="o">-</span><span class="n">Jval</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Jval</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">Jval</span><span class="o">%</span><span class="mi">1</span><span class="o">==</span><span class="mf">0.5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freeionkets</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;|</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">/2&gt;&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linspace</span><span class="p">(</span><span class="n">Jval</span><span class="p">,</span><span class="o">-</span><span class="n">Jval</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Jval</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>
        
        
        <span class="c1"># THE HAMILTONIAN</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span>  \
            <span class="n">B</span><span class="o">.</span><span class="n">B20</span> <span class="o">*</span> <span class="n">O_20</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B22</span> <span class="o">*</span> <span class="n">O_22</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B40</span> <span class="o">*</span> <span class="n">O_40</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B42</span> <span class="o">*</span> <span class="n">O_42</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B44</span> <span class="o">*</span> <span class="n">O_44</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B60</span> <span class="o">*</span> <span class="n">O_60</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B62</span> <span class="o">*</span> <span class="n">O_62</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B64</span> <span class="o">*</span> <span class="n">O_64</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">B</span><span class="o">.</span><span class="n">B66</span> <span class="o">*</span> <span class="n">O_66</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">C</span><span class="o">.</span><span class="n">uB</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">gJ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hfield</span><span class="p">)</span>
        
        <span class="c1"># Diagonalize the Hamiltonian</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">diagonalize</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagonalize</span><span class="p">()</span>
    
<div class="viewcode-block" id="CEFion.diagonalize"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.CEFion.diagonalize">[docs]</a>    <span class="k">def</span> <span class="nf">diagonalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortWithE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shiftToZero</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Diagonalize the Hamiltonian, and change to the sorted eigenvector base. The default sorting is done according to eigenenergies, so that the first vector [1,0,...,0] is the lowest eigenstate, and the last one [0,...,0,1] is the highest one. Changing the base greatly faiclitates further calculations based on the evaluation of matrix elements.</span>
<span class="sd">        </span>
<span class="sd">        It updates the attributes: {``Jx``,``Jy``,``Jz``,``J``,``energies``,``eigenvectors``,``degeneracies``}.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError </span>
<span class="sd">                If the calculated eigenenergies are not real.</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># Diagonalize the Hamiltonian</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">E</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Final energies are complex!&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">shiftToZero</span><span class="p">)</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>     <span class="c1"># shift to zero level</span>

        <span class="c1"># TODO check if U is orthogonal based on comparison with QR decomposition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">U</span>
        

        <span class="c1"># Sorting</span>
        <span class="k">if</span> <span class="n">sortWithE</span><span class="p">:</span>
            <span class="n">sortedIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sortedIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">Jval</span><span class="p">)</span>
            

        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[:,</span><span class="n">sortedIndices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">sortedIndices</span><span class="p">]</span>
        
        
        
        <span class="c1"># Change the basis of principal operators to the eigenstate basis with specified sorting scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Jx</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Jy</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jy</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Jz</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jz</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Jx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Jz</span><span class="p">])</span>

        

        <span class="c1">#calculate degeneracy</span>
        <span class="n">deg_e</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">deg_e</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">deg_e</span><span class="p">[</span><span class="n">levels</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">):</span>
                <span class="n">levels</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">deg_e</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deg_e</span><span class="p">[</span><span class="n">levels</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">degeneracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deg_e</span><span class="p">)</span>   </div>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nice printout of calculated parameters</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">            precision : int, optional</span>
<span class="sd">                How many significant digits should be shown for printout of energy and eigenvector coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;Energy levels and corresponding eigenfunctions:</span><span class="se">\n</span><span class="s2">&quot;</span>
               
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degeneracies</span><span class="p">):</span>
            <span class="n">level_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">degeneracy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">level_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;E(</span><span class="si">{</span><span class="n">level</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">) =</span><span class="se">\t</span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s1">.</span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">degeneracy</span><span class="si">:</span><span class="s1">2d</span><span class="si">}</span><span class="s1">fold-degenerated</span><span class="se">\n</span><span class="s1">&#39;</span>
            
            <span class="c1"># List degenerated eigenvectors</span>
            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">degeneracy</span><span class="p">]:</span>
                <span class="n">ev_components</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">ket</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">freeionkets</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-15</span><span class="p">:</span>    <span class="c1"># Arbitrary tolerance</span>
                        <span class="n">ev_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">.</span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">ket</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        
                <span class="n">level_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ev_components</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level_str</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">degeneracy</span>
        
        <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>
      
    

<div class="viewcode-block" id="boltzman_population"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.boltzman_population">[docs]</a><span class="k">def</span> <span class="nf">boltzman_population</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the population of energy levels at given temperature based on the Boltzmann statistic.</span>
<span class="sd">    </span>
<span class="sd">    :math:`n_i = \\frac{1}{Z} e^{-Ei/k_B T}`</span>
<span class="sd">    </span>
<span class="sd">    :math:`Z = \\sum_i e^{-Ei/k_BT}`</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        energies : array_like</span>
<span class="sd">            List of energy levels in meV units</span>
<span class="sd">        tmperature : float</span>
<span class="sd">            Temperature at which to evaluate the statistic</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of occupation probabilities for each energy level.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">energies</span><span class="o">*</span><span class="n">C</span><span class="o">.</span><span class="n">eV2K</span><span class="o">/</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="n">Z</span></div>

<span class="k">def</span> <span class="nf">_rawneutronint</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">J2_perp</span><span class="p">,</span> <span class="n">gJ</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns transition intensities in barn.</span>
<span class="sd">    </span>
<span class="sd">    TODO I think the Bebye-Waller factor needs to be incorporated here for proper inter-Temperature comparisons</span>

<span class="sd">    Args:</span>
<span class="sd">        E (2D array of floats): matrix of energy changes corresponding to transitions in meV</span>
<span class="sd">        J2_perp (2D array of floats): matrix of squared J</span>
<span class="sd">        gJ (float): Landé factor</span>
<span class="sd">        T (float): temperature in **K**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r02</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">R0</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">R0</span>  <span class="o">*</span><span class="mf">1e28</span> <span class="c1"># to have value in barn</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r02</span> <span class="o">*</span> <span class="n">gJ</span> <span class="o">*</span> <span class="n">gJ</span>
    
    <span class="c1"># Calculate the occupancy of the levels at given temperature</span>
    <span class="n">prst</span> <span class="o">=</span> <span class="n">boltzman_population</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">T</span><span class="p">)</span>
    
    <span class="c1"># Multiply the matrix elements by uprobability of occupying certain level</span>
    <span class="n">trans_int</span> <span class="o">=</span> <span class="n">J2_perp</span> <span class="o">*</span> <span class="n">prst</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1">#transition intensities in barn</span>
    
    <span class="k">return</span> <span class="n">trans_int</span>

<div class="viewcode-block" id="neutronint"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.neutronint">[docs]</a><span class="k">def</span> <span class="nf">neutronint</span><span class="p">(</span><span class="n">cefion</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;powder&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns matrix of energies and inelastic neutron scattering spectral weights for all possible transitions at given temperature. The spectral weight is calcula equation from Enderle book following Stephane Raymond article </span>
<span class="sd">    :math:`S(\\vec{Q},\\omega) = N (\\gamma r_0)^2 \\frac{k_f}{k_i} f^2_m(Q) e^{-2W(Q)} \\sum_{nm} p_n |&lt;\\lambda_f|J_\perp|\\lambda_i&gt;|^2 \\delta()`</span>
<span class="sd">    The intensities are evaluated based on the :math:`|&lt;\\lambda_f|J_\perp|\\lambda_i&gt;|^2` matrix elements, which form a matrix :math:`|J_\perp|^2`.</span>
<span class="sd">    Two main cases are implemented and encoded in the :data:`direction` parameter.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        cefion : :obj:`crysfipy.reion.CEFion` </span>
<span class="sd">            Rare-earth ion in the crystal field</span>
<span class="sd">        T : float</span>
<span class="sd">            Temperature in *K*</span>
<span class="sd">        direction : &#39;powder&#39; or ndarray, optional</span>
<span class="sd">            Scheme according to which :math:`|J_\perp|^2` is calculated.</span>
<span class="sd">            </span>
<span class="sd">            * powder :  :math:`|J_\perp|^2 = 2/3(|J_x|^2+|J_y|^2+|J_z|^2)` (default)</span>
<span class="sd">            * 3x float - vector representing a direction in the reciprocal space in respect to which a perpendicular projection of :math:`J` will be calculated.</span>

<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        energies : ndarray</span>
<span class="sd">            Array containing energies of the transitions</span>
<span class="sd">        intensities : ndarray</span>
<span class="sd">            Array containing intensities of the transitions</span>
<span class="sd">            </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError </span>
<span class="sd">            When an invalid ``direction`` parameter is chosen, or the dimension of the ``direction`` vector is not 3.</span>
<span class="sd">        </span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Tricky way to create a 2D array of energies associated with transitions between levels</span>
    <span class="n">jumps</span> <span class="o">=</span> <span class="n">cefion</span><span class="o">.</span><span class="n">energies</span> <span class="o">-</span> <span class="n">cefion</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    
    
    <span class="c1"># Calculate the |&lt;\Gamma_f|J_\perp|\Gamma_i&gt;|^2 matrix</span>
    <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;powder&#39;</span><span class="p">:</span>
        <span class="n">J2_perp</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;jk&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cefion</span><span class="o">.</span><span class="n">J</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dimension of the``direction`` vector is not 3&#39;</span><span class="p">)</span>
            
        <span class="n">Qperp_projectCEFion</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">perp_matrix</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">J_perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jkl&#39;</span><span class="p">,</span><span class="n">Qperp_projectCEFion</span><span class="p">,</span> <span class="n">cefion</span><span class="o">.</span><span class="n">J</span><span class="p">)</span>
        <span class="n">J2_perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;jk&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">J_perp</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid ``direction`` parameter&#39;</span><span class="p">)</span>
        

    <span class="n">Dintensities</span> <span class="o">=</span> <span class="n">_rawneutronint</span><span class="p">(</span><span class="n">jumps</span><span class="p">,</span> <span class="n">J2_perp</span><span class="p">,</span> <span class="n">cefion</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">gJ</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">Denergies</span> <span class="o">=</span> <span class="n">jumps</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">sorting</span> <span class="o">=</span> <span class="n">Denergies</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Denergies</span><span class="p">[</span><span class="n">sorting</span><span class="p">],</span> <span class="n">Dintensities</span><span class="p">[</span><span class="n">sorting</span><span class="p">])</span> </div>

<div class="viewcode-block" id="magnetization"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.magnetization">[docs]</a><span class="k">def</span> <span class="nf">magnetization</span><span class="p">(</span><span class="n">cefion</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Hfield</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the magnetization of the single ion in the crystal field.</span>
<span class="sd">    :math:`M_\\alpha = g_J \\sum_n p_n &lt;\\lambda_n | \hat{J}_\\alpha | \\lambda_n&gt;`</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">cefion_inH</span> <span class="o">=</span> <span class="n">CEFion</span><span class="p">(</span><span class="n">cefion</span><span class="o">.</span><span class="n">ion</span><span class="p">,</span> <span class="n">Hfield</span><span class="p">,</span> <span class="n">cefion</span><span class="o">.</span><span class="n">cfp</span><span class="p">,</span> <span class="n">diagonalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># The diagonalized Hamiltonians operators are already transformed into the sorted eigenvector base, </span>
    
    
    
    <span class="k">return</span> <span class="n">cefion_inH</span></div>


<span class="k">def</span> <span class="nf">_rawsusceptibility</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">moment</span><span class="p">,</span> <span class="n">H_direction</span><span class="p">,</span> <span class="n">H_size</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns susceptibility calculated for energy levels at given temperature&quot;&quot;&quot;</span>

    <span class="n">prst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">energy</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">prst</span><span class="p">);</span>                                    <span class="c1"># canonical partition function </span>
    <span class="n">prst</span> <span class="o">=</span> <span class="n">prst</span> <span class="o">/</span> <span class="n">Z</span><span class="p">;</span>
    <span class="n">overal_moment</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">prst</span><span class="p">,</span> <span class="n">moment</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">overal_moment</span><span class="p">,</span> <span class="n">H_direction</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="n">H_size</span>

<div class="viewcode-block" id="susceptibility"><a class="viewcode-back" href="../../../source/crysfipy.html#mikibox.crysfipy.reion.susceptibility">[docs]</a><span class="k">def</span> <span class="nf">susceptibility</span><span class="p">(</span><span class="n">ion</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns susceptibility calculated for given ion at given temperature&quot;&quot;&quot;</span>

    <span class="c1"># TODO complete rework</span>
    <span class="c1"># Next liens are taken from the previous version od the code</span>
    <span class="c1"># self.moment[:,0] = - self.ion.gJ * np.real(diag(self.Jx))</span>
    <span class="c1"># self.moment[:,1] = - self.ion.gJ * np.real(diag(self.Jy))                      </span>
    <span class="c1"># self.moment[:,2] = - self.ion.gJ * np.real(diag(self.Jz))</span>

    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rawsusceptibility</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">H_direction</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">H_size</span><span class="p">,</span> <span class="n">temp</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">te</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_rawsusceptibility</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">H_direction</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">H_size</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Michal Stekiel.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>